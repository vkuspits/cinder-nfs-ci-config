#git clone plugin, build cinder-nfs-plugin
- job:
    name: cinder-nfs-plugin-build
    project-type: freestyle
    defaults: global
    node: slave
    description: |
      This job is managed by Jenkins Job Builder, do not edit it through WebUI.
      Please use this repository to make changes: <a href= "https://github.com/vkuspits/cinder-nfs-ci-config\">https://github.com/vkuspits/cinder-nfs-ci-config</a>
      Title: Cinder-nfs-plugin-build job 
      Description: This job check repository with cinder-nfs-plugin, and build this plugin. 
      Maintainer: Vladislav Kuspits
    disabled: false
#Require slack notification
    publishers:
      - workspace-cleanup:
        clean-if:
          - success: false
          - not-built: true
          - aborted: true
      - slack:
          room: '@vkuspits'
          team-domain: 'miracloud'
          auth-token: 'rI9LMiXqaIenTY5UGrTpzVhE'
          notify-success: true
          notify-aborted: true
          notify-not-built: true
          notify-failure: true
      - archive:
          artifacts: '*.rpm'
          allow-empty: 'true'
          fingerprint: false
          default-excludes: false
      - trigger:
           project: 'revert_snapshot'
#Git-plugin
    scm:
      - git:
          url: 'https://github.com/vkuspits/cinder-nfs-plugin'
          branches:
            - 'origin/master'
#Gerrit trigger
    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event:
                exclude-drafts: true
                exclude-trivial-rebase: true
                exclude-no-code-change: false
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: 'vkuspits/cinder-nfs-plugin'
              branch-pattern: 'master'
    builders:
      - shell: |
            git branch "jobbr${BUILD_NUMBER}"
            fpb --build $WORKSPACE

#Create MOS env via fuel-devops
- job:
    name: revert_snapshot
    project-type: freestyle
    defaults: global
    node: slave
    description: |
      This job is managed by Jenkins Job Builder, do not edit it through WebUI.
      Please use this repository to make changes: <a href= "https://github.com/vkuspits/cinder-nfs-ci-config\">https://github.com/vkuspits/cinder-nfs-ci-config</a>
      Title: Revert snapshot
      Description: This job revert snapshot with fuel env. 
      Maintainer: Vladislav Kuspits
    disabled: false
    parametrs:
      - string:
          name: FUEL-DEVOPS_DIR
          default: /home/vlad/working_dir/fuel-devops-venv/
          description: "Urs fuel-devops-venv dir"
      - string:
          name: ENV_NAME
          default: cinder-nfs-ci
          description: "Name fuel-devops env"
      - string:
          name: SNAPSHOT_NAME
          default: ready-env_snapshot
          description: "Name of snap"
    publishers:
      - workspace-cleanup:
          clean-if:
            - success: false
            - not-built: true
            - aborted: true
      - trigger:
           project: 'deploy-plugin'
      - slack:
          room: '@vkuspits'
          team-domain: 'miracloud'
          auth-token: 'rI9LMiXqaIenTY5UGrTpzVhE'
          notify-success: true
          notify-aborted: true
          notify-not-built: true
          notify-failure: true
      - archive:
          artifacts: '*.sh, *.py'
          allow-empty: 'true'
          fingerprint: false
          default-excludes: false
    builders:
      - shell: |
          rm -rf cinder-nfs-ci-config
          git clone -o origin -b using_snapshot https://github.com/vkuspits/cinder-nfs-ci-config.git
          cd $FUEL-DEVOPS_DIR
          dos.py start $ENV_NAME
          dos.py revert $ENV_NAME $SNAPSHOT_NAME
- job:
    name: deploy-plugin
    project-type: freestyle
    defaults: global
    node: Fuel
    description: |
      This job is managed by Jenkins Job Builder, do not edit it through WebUI.
      Please use this repository to make changes: <a href= "https://github.com/vkuspits/cinder-nfs-ci-config\">https://github.com/vkuspits/cinder-nfs-ci-config</a>
      Title: Deploy plugin in fuel env
      Description: This job deploy cinder-nfs-plugin on fuel env. 
      Maintainer: Vladislav Kuspits
    disabled: false
    publishers:
      - workspace-cleanup:
          clean-if:
            - success: false
            - not-built: true
            - aborted: true
      - slack:
          room: '@vkuspits'
          team-domain: 'miracloud'
          auth-token: 'rI9LMiXqaIenTY5UGrTpzVhE'
          notify-success: true
          notify-aborted: true
          notify-not-built: true
          notify-failure: true
    builders:
      - copyartifact:
          project: cinder-nfs-plugin-build
          filter: "*.rpm"
          target: "plugin/"
      - copyartifact:
          project: revert_snapshot
          filter: "*.sh, *.py"
          target: "scripts/"
      - shell: |
          . openstack-env.sh 