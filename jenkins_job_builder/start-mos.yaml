#git clone plugin, build cinder-nfs-plugin
- job:
    name: cinder-nfs-plugin-build
    project-type: freestyle
    defaults: global
    node: slave
    description: |
      This job is managed by Jenkins Job Builder, do not edit it through WebUI.
      Please use this repository to make changes: <a href= "https://github.com/vkuspits/cinder-nfs-ci-config\">https://github.com/vkuspits/cinder-nfs-ci-config</a>
      Title: Cinder-nfs-plugin-build job 
      Description: This job updates all other jobs from Cinder-nfs-plugin-build repo. 
      Maintainer: Vladislav Kuspits
    disabled: false
#Require slack notification
    publishers:
      - slack:
          room: '@vkuspits'
          team-domain: 'miracloud'
          auth-token: 'rI9LMiXqaIenTY5UGrTpzVhE'
          notify-success: true
          notify-aborted: true
          notify-not-built: true
          notify-failure: true
      - trigger:
           project: 'deploy-plugin_snapshot'

    scm:
      - git:
          url: 'https://github.com/vkuspits/cinder-nfs-plugin'
          branches:
            - 'origin/master'
    triggers:
      - gerrit:
          trigger-on:
            - patchset-created-event:
                exclude-drafts: true
                exclude-trivial-rebase: true
                exclude-no-code-change: false
          projects:
            - project-compare-type: 'PLAIN'
              project-pattern: 'vkuspits/cinder-nfs-plugin'
              branch-pattern: 'master'
    builders:
      - shell: |
            git branch "jobbr${BUILD_NUMBER}"
            fpb --build $WORKSPACE

#Create MOS env via fuel-devops
- job:
    name: deploy-plugin_snapshot
    project-type: freestyle
    defaults: global
    node: slave
    description: |
      This job is managed by Jenkins Job Builder, do not edit it through WebUI.
      Please use this repository to make changes: <a href= "https://github.com/vkuspits/cinder-nfs-ci-config\">https://github.com/vkuspits/cinder-nfs-ci-config</a>
      Title: Environment configuration job 
      Description: This job updates all other jobs from Cinder-nfs-plugin-build repo. 
      Maintainer: Vladislav Kuspits
    disabled: false
    publishers:
      - workspace-cleanup:
          clean-if:
            - success: false
            - not-built: true
            - aborted: true
      - trigger:
           project: 'deploy-plugin'
      - slack:
          room: '@vkuspits'
          team-domain: 'miracloud'
          auth-token: 'rI9LMiXqaIenTY5UGrTpzVhE'
          notify-success: true
          notify-aborted: true
          notify-not-built: true
          notify-failure: true
    builders:
      - shell: |
          rm -rf cinder-nfs-ci-config
          git clone https://github.com/vkuspits/cinder-nfs-ci-config.git
          puppet apply $WORKSPACE/cinder-nfs-ci-config/puppet/manifest/ssh-to-master.pp
          cd $fuel_devops_dir
          dos.py start $ENV_NAME
          dos.py revert $ENV_NAME $SNAPSHOT_NAME
          cd $WORKSPACE
          cd ..
          scp cinder-nfs-plugin-build/nfs-* $master_connection:/tmp
          scp $WORKSPACE/cinder-nfs-ci-config/python/settings.py \
          $master_connection:/root
          ssh $master_connection
          openstack-env.sh