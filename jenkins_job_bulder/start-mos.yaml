#git clone plugin, build cinder-nfs-plugin
- job:
    name: cinder-nfs-plugin-build
    project-type: freestyle
    defaults: global
    parametrs:
      - node: slave
    description: |
      This job is managed by Jenkins Job Builder, do not edit it through WebUI.
      Please use this repository to make changes: <a href= "https://github.com/vkuspits/cinder-nfs-ci-config\">https://github.com/vkuspits/cinder-nfs-ci-config</a>
      Title: Cinder-nfs-plugin-build job 
      Description: This job updates all other jobs from Cinder-nfs-plugin-build repo. 
      Maintainer: Vladislav Kuspits
    disabled: false
#Require slack notification
    publishers:
      - slack:
          room: @vkuspits
          notify-success: true
          notify-aborted: true
          notify-not-built: true
          notify-failure: true
      - trigger:
           project: 'env-config'

    scm:
      - git:
          url: 'https://github.com/vkuspits/cinder-nfs-plugin.git'
          branches:
            - 'origin/master'
    builders:
      - shell: |
            cd $WORKSPACE/cinder-nfs-plugin-build
            fpb --build cinder-nfs-plugin

#Create MOS env via fuel-devops
- job:
    name: env-config
    project-type: freestyle
    defaults: global
    parametrs:
      - node: slave
    description: |
      This job is managed by Jenkins Job Builder, do not edit it through WebUI.
      Please use this repository to make changes: <a href= "https://github.com/vkuspits/cinder-nfs-ci-config\">https://github.com/vkuspits/cinder-nfs-ci-config</a>
      Title: Environment configuration job 
      Description: This job updates all other jobs from Cinder-nfs-plugin-build repo. 
      Maintainer: Vladislav Kuspits
    disabled: false
    publishers:
      - workspace-cleanup:
          clean-if:
            - success: true
            - not-built: true
            - aborted: true
      - trigger:
           project: 'deploy-plugin'
      - slack:
          room: @vkuspits
          notify-success: true
          notify-aborted: true
          notify-not-built: true
          notify-failure: true
    builders:
      - shell: |
          puppet apply $WORKSPACE/cinder-nfs-ci-config/puppet/manifest/site.pp
#Copy>install>deploy cinder-nfs-plugin
- job:
    name: deploy-plugin
    project-type: freestyle
    defaults: global
    parametrs:
      - node: slave
    description: |
      This job is managed by Jenkins Job Builder, do not edit it through WebUI.
      Please use this repository to make changes: <a href= "https://github.com/vkuspits/cinder-nfs-ci-config\">https://github.com/vkuspits/cinder-nfs-ci-config</a>
      Title: Install and deploy plugin job 
      Description: This job updates all other jobs from Cinder-nfs-plugin-build repo. 
      Maintainer: Vladislav Kuspits
    disabled: false
    publishers:
      - workspace-cleanup:
          clean-if:
            - success: true
            - not-built: true
            - aborted: true
      - trigger:
           project: 'deploy-success'
      - slack:
          room: @vkuspits
          notify-success: true
          notify-aborted: true
          notify-not-built: true
          notify-failure: true
    builders:
      - shell: |
          puppet apply $WORKSPACE/cinder-nfs-ci-config/puppet/manifest/ssh-to-master.pp
          scp $WORKSPACE/cinder-nfs-plugin-build/cinder-nfs-plugin/nfs-* root@10.10.0.2:/tmp
          scp $WORKSPACE/cinder-nfs-ci-config/python/settings.py root@10.10.0.2:/tmp
          ssh root@10.10.0.2
          openstack-env.sh
- job:
    name: deploy-success
    project-type: freestyle
    defaults: global
    parametrs:
      - node: slave
    description: |
      This job is managed by Jenkins Job Builder, do not edit it through WebUI.
      Please use this repository to make changes: <a href= "https://github.com/vkuspits/cinder-nfs-ci-config\">https://github.com/vkuspits/cinder-nfs-ci-config</a>
      Title: job 
      Description: This job updates all other jobs from Cinder-nfs-plugin-build repo. 
      Maintainer: Vladislav Kuspits
    disabled: false
    publishers:
      - workspace-cleanup:
          clean-if:
            - success: true
            - not-built: true
            - aborted: true
      - slack:
          room: @vkuspits
          notify-success: true
          notify-aborted: true
          notify-not-built: true
          notify-failure: true
    builders:
      - shell: |
          echo "deploy-plugin succesfull" >> $WORKSPACE/cinder-nfs-plugin/job_result

- project:
    name: start-mos
    mos:
      - '9.0'
    jobs:
      - 'cinder-nfs-plugin-build'
      - 'env-config'
      - 'deploy-plugin'
      - 'deploy-success'