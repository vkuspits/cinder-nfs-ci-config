#git clone plugin, build cinder-nfs-plugin
- job:
    name: cinder-nfs-plugin-build
    project-type: freestyle
    defaults: global
    parametrs:
      - node: Vkuspits-pc
    description: |
      <p><b>This job is managed automatically and will be overwritten.</b></p>
      <p><b>Do not edit this job through the web</b></p>
      <p>If you would like to make changes to this job, please see:
        <a href="https://github.com/vkuspits/cinder-nfs-ci-config">
          https://github.com/vkuspits/cinder-nfs-ci-config
        </a>
      </p>
    disabled: false
#Require slack notification
    properties:
      - slack:
          room: @vkuspits
          notify-success: true
          notify-aborted: true
          notify-not-built: true
          notify-failure: true

    scm:
      - git:
          url: 'https://github.com/vkuspits/cinder-nfs-plugin.git'
          branches:
            - 'origin/master'
    builders:
      - shell: |
            fpb --build cinder-nfs-plugin

#Create MOS env via fuel-devops
- job:
    name: env-config
    project-type: freestyle
    defaults: global
    parametrs:
      - node: Vkuspits-pc
    description: |
      <p><b>This job is managed automatically and will be overwritten.</b></p>
      <p><b>Do not edit this job through the web</b></p>
      <p>If you would like to make changes to this job, please see:
        <a href="https://github.com/vkuspits/cinder-nfs-ci-config">
          https://github.com/vkuspits/cinder-nfs-ci-config
        </a>
      </p>
    disabled: false
    publishers:
      - workspace-cleanup:
          clean-if:
            - success: true
            - not-built: true
            - aborted: true
      - trigger:
           project: 'cinder-nfs-plugin-build'

    properties:
      - slack:
          room: @vkuspits
          notify-success: true
          notify-aborted: true
          notify-not-built: true
          notify-failure: true
    builders:
      - shell: |
          puppet apply $WORKSPACE/cinder-nfs-ci-config/puppet/manifest/site.pp
#Copy>install>deploy cinder-nfs-plugin
- job:
    name: deploy-plugin
    project-type: freestyle
    defaults: global
    parametrs:
      - node: Vkuspits-pc
    description: |
      <p><b>This job is managed automatically and will be overwritten.</b></p>
      <p><b>Do not edit this job through the web</b></p>
      <p>If you would like to make changes to this job, please see:
        <a href="https://github.com/vkuspits/cinder-nfs-ci-config">
          https://github.com/vkuspits/cinder-nfs-ci-config
        </a>
      </p>
    disabled: false
    publishers:
      - workspace-cleanup:
          clean-if:
            - success: true
            - not-built: true
            - aborted: true
      - trigger:
           project: 'env-config'

    properties:
      - slack:
          room: @vkuspits
          notify-success: true
          notify-aborted: true
          notify-not-built: true
          notify-failure: true
    builders:
      - shell: |
          #переписать установку венва на слейва, а не в папку дженкинса
          puppet apply $WORKSPACE/cinder-nfs-ci-config/puppet/manifest/ssh-to-master.pp
          scp $WORKSPACE/cinder-nfs-ci-config/cinder-nfs-plugin/nfs-* root@10.10.0.2:/tmp
          scp $WORKSPACE/cinder-nfs-ci-config/python/settings.py root@10.10.0.2:/tmp
          ssh root@10.10.0.2
          openstack-env.sh
- job:
    name: deploy-success
    project-type: freestyle
    defaults: global
    parametrs:
      - node: Vkuspits-pc
    description: |
      <p><b>This job is managed automatically and will be overwritten.</b></p>
      <p><b>Do not edit this job through the web</b></p>
      <p>If you would like to make changes to this job, please see:
        <a href="https://github.com/vkuspits/cinder-nfs-ci-config">
          https://github.com/vkuspits/cinder-nfs-ci-config
        </a>
      </p>
    disabled: false
    publishers:
      - workspace-cleanup:
          clean-if:
            - success: true
            - not-built: true
            - aborted: true
      - trigger:
           project: 'deploy-plugin'
    properties:
      - slack:
          room: @vkuspits
          notify-success: true
          notify-aborted: true
          notify-not-built: true
          notify-failure: true
    builders:
      - shell: |
          echo "deploy-plugin succesfull" >> $WORKSPACE/cinder-nfs-plugin/job_result

- project:
    name: start-mos
    mos:
      - '9.0'
    jobs:
      - 'cinder-nfs-plugin-build'
      - 'env-config'
      - 'deploy-plugin'
      - 'deploy-success'